{% extends 'admin/base_site.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Admin Dashboard - RIVI√àRE RV PARK{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<style>
    body {
        background-color: #f5f5f5;
    }
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .dashboard-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e14d2a;
    }
    .dashboard-header h1 {
        color: #333;
        margin: 0;
        font-size: 32px;
    }
    .dashboard-header p {
        color: #666;
        margin: 5px 0 0 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 5px solid #e14d2a;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-card.secondary {
        border-left-color: #4CAF50;
    }
    .stat-card.warning {
        border-left-color: #FF9800;
    }
    .stat-card.info {
        border-left-color: #2196F3;
    }
    .stat-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }
    .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    .stat-subtext {
        font-size: 12px;
        color: #999;
    }
    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin-top: 30px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e14d2a;
    }
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-card h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .table-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow-x: auto;
    }
    .table-card h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    table th {
        background-color: #f9f9f9;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e14d2a;
    }
    table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    table tr:hover {
        background-color: #f9f9f9;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    .status-confirmed {
        background-color: #d4edda;
        color: #155724;
    }
    .status-completed {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .status-cancelled {
        background-color: #f8d7da;
        color: #721c24;
    }
    .land-status-available {
        background-color: #d4edda;
        color: #155724;
    }
    .land-status-booked {
        background-color: #f8d7da;
        color: #721c24;
    }
    .time-period-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    .time-period-tabs button {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #999;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    .time-period-tabs button.active {
        color: #e14d2a;
        border-bottom-color: #e14d2a;
    }
    .top-performers {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .performer-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .performer-card h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }
    .performer-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .performer-item:last-child {
        border-bottom: none;
    }
    .performer-name {
        color: #333;
        font-weight: 500;
    }
    .performer-value {
        color: #e14d2a;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>üìä Admin Dashboard</h1>
        <p>Welcome to RIVI√àRE RV PARK Analytics & Management Center</p>
    </div>

    <!-- Overall Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">üìà Total Revenue</div>
            <div class="stat-value">${{ total_revenue|floatformat:2 }}</div>
            <div class="stat-subtext">All-time confirmed bookings</div>
        </div>

        <div class="stat-card secondary">
            <div class="stat-label">üìÖ Total Bookings</div>
            <div class="stat-value">{{ total_bookings }}</div>
            <div class="stat-subtext">Including all statuses</div>
        </div>

        <div class="stat-card info">
            <div class="stat-label">üèïÔ∏è Available Sites</div>
            <div class="stat-value">{{ total_lands }}</div>
            <div class="stat-subtext">Total RV sites</div>
        </div>

        <div class="stat-card warning">
            <div class="stat-label">‚è≥ Pending Bookings</div>
            <div class="stat-value">{{ pending_bookings }}</div>
            <div class="stat-subtext">Awaiting confirmation</div>
        </div>

        <div class="stat-card secondary">
            <div class="stat-label">üìä Occupancy Rate</div>
            <div class="stat-value">{{ occupancy_rate }}%</div>
            <div class="stat-subtext">Last 30 days</div>
        </div>

        <div class="stat-card info">
            <div class="stat-label">üí∞ Avg Booking Value</div>
            <div class="stat-value">${{ avg_booking_value|floatformat:2 }}</div>
            <div class="stat-subtext">Average confirmed booking</div>
        </div>
    </div>

    <!-- Period Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">üìà Revenue (30 Days)</div>
            <div class="stat-value">${{ revenue_30|floatformat:2 }}</div>
            <div class="stat-subtext">{{ bookings_30_count }} bookings</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">üìà Revenue (90 Days)</div>
            <div class="stat-value">${{ revenue_90|floatformat:2 }}</div>
            <div class="stat-subtext">{{ bookings_90_count }} bookings</div>
        </div>

        <div class="stat-card secondary">
            <div class="stat-label">‚è±Ô∏è Avg Stay Length</div>
            <div class="stat-value">{{ avg_booking_nights }} nights</div>
            <div class="stat-subtext">Average booking duration</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="section-title">üìä Analytics & Trends</div>
    <div class="charts-grid">
        <div class="chart-card">
            <h3>Booking Timeline (Last 30 Days)</h3>
            <div class="chart-container">
                <canvas id="bookingChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>Revenue Timeline (Last 30 Days)</h3>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>Booking Status Distribution</h3>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>Site Status Distribution</h3>
            <div class="chart-container">
                <canvas id="landStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Performers Section -->
    <div class="section-title">‚≠ê Top Performers</div>
    <div class="top-performers">
        <div class="performer-card">
            <h3>Top Sites by Bookings</h3>
            {% for land in top_lands %}
            <div class="performer-item">
                <span class="performer-name">{{ land.name }}</span>
                <span class="performer-value">{{ land.booking_count }} bookings</span>
            </div>
            {% empty %}
            <p style="color: #999;">No bookings yet</p>
            {% endfor %}
        </div>

        <div class="performer-card">
            <h3>Top Sites by Revenue</h3>
            {% for land in top_lands_revenue %}
            <div class="performer-item">
                <span class="performer-name">{{ land.name }}</span>
                <span class="performer-value">${{ land.total_revenue|floatformat:2 }}</span>
            </div>
            {% empty %}
            <p style="color: #999;">No revenue data yet</p>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Bookings Section -->
    <div class="section-title">üìã Recent Bookings</div>
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>Booking ID</th>
                    <th>Guest Name</th>
                    <th>Site</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in recent_bookings %}
                <tr>
                    <td><strong>#{{ booking.id }}</strong></td>
                    <td>{{ booking.guest_name }}</td>
                    <td>{{ booking.land.name }}</td>
                    <td>{{ booking.check_in|date:"M d, Y" }}</td>
                    <td>{{ booking.check_out|date:"M d, Y" }}</td>
                    <td>${{ booking.total_price|floatformat:2 }}</td>
                    <td>
                        <span class="status-badge status-{{ booking.status|lower }}">
                            {{ booking.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; color: #999;">No bookings yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Upcoming Bookings Section -->
    <div class="section-title">üìÖ Upcoming Bookings (Next 30 Days)</div>
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>Booking ID</th>
                    <th>Guest Name</th>
                    <th>Site</th>
                    <th>Check-in</th>
                    <th>Duration</th>
                    <th>Guests</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in upcoming_bookings %}
                <tr>
                    <td><strong>#{{ booking.id }}</strong></td>
                    <td>{{ booking.guest_name }}</td>
                    <td>{{ booking.land.name }}</td>
                    <td>{{ booking.check_in|date:"M d, Y" }}</td>
                    <td>{{ booking.total_nights }} nights</td>
                    <td>{{ booking.number_of_guests }}</td>
                    <td>
                        <span class="status-badge status-{{ booking.status|lower }}">
                            {{ booking.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; color: #999;">No upcoming bookings</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Booking Status Breakdown -->
    <div class="section-title">üìä Booking Status Breakdown</div>
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Count</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for status in status_distribution %}
                {% with total=status.count percent=status.count|add:0 %}
                <tr>
                    <td>
                        <span class="status-badge status-{{ status.status|lower }}">
                            {{ status.status|upper }}
                        </span>
                    </td>
                    <td>{{ status.count }}</td>
                    <td>{% if total_bookings %}{{ status.count|mul:100|div:total_bookings|floatformat:1 }}%{% else %}0%{% endif %}</td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align: center; color: #999;">No booking data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Site Status Breakdown -->
    <div class="section-title">üèïÔ∏è Site Status Breakdown</div>
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Count</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for status in land_status %}
                <tr>
                    <td>
                        <span class="status-badge land-status-{{ status.status|lower }}">
                            {{ status.status|upper }}
                        </span>
                    </td>
                    <td>{{ status.count }}</td>
                    <td>{% if total_lands %}{{ status.count|mul:100|div:total_lands|floatformat:1 }}%{% else %}0%{% endif %}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align: center; color: #999;">No site data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Color scheme
    const primaryColor = '#e14d2a';
    const successColor = '#4CAF50';
    const warningColor = '#FF9800';
    const infoColor = '#2196F3';
    const dangerColor = '#F44336';

    // Booking Timeline Chart
    const bookingCtx = document.getElementById('bookingChart').getContext('2d');
    const bookingData = {{ booking_timeline|safe }};
    const bookingLabels = bookingData.map(d => d.date);
    const bookingValues = bookingData.map(d => d.count);

    new Chart(bookingCtx, {
        type: 'line',
        data: {
            labels: bookingLabels,
            datasets: [{
                label: 'Bookings Created',
                data: bookingValues,
                borderColor: primaryColor,
                backgroundColor: primaryColor + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: primaryColor,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Revenue Timeline Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueData = {{ revenue_timeline|safe }};
    const revenueLabels = revenueData.map(d => d.date);
    const revenueValues = revenueData.map(d => d.revenue);

    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: revenueLabels,
            datasets: [{
                label: 'Revenue ($)',
                data: revenueValues,
                backgroundColor: successColor,
                borderColor: successColor,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Booking Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusDistribution = {{ status_distribution|safe }};
    const statusLabels = statusDistribution.map(s => s.status.charAt(0).toUpperCase() + s.status.slice(1));
    const statusValues = statusDistribution.map(s => s.count);
    const statusColors = ['#FF9800', '#4CAF50', '#F44336', '#2196F3'];

    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusValues,
                backgroundColor: statusColors.slice(0, statusValues.length),
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Land Status Chart
    const landStatusCtx = document.getElementById('landStatusChart').getContext('2d');
    const landDistribution = {{ land_status|safe }};
    const landLabels = landDistribution.map(s => s.status.charAt(0).toUpperCase() + s.status.slice(1));
    const landValues = landDistribution.map(s => s.count);
    const landColors = ['#4CAF50', '#F44336'];

    new Chart(landStatusCtx, {
        type: 'pie',
        data: {
            labels: landLabels,
            datasets: [{
                data: landValues,
                backgroundColor: landColors.slice(0, landValues.length),
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>

<!-- Custom filters for template math -->
<style>
    /* Additional spacing */
    .dashboard-container {
        background-color: #f5f5f5;
        min-height: 100vh;
    }
</style>
{% endblock %}
