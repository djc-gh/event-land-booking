{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
    :root {
        --dashboard-primary: #417690;
        --dashboard-success: #417690;
        --dashboard-warning: #f39c12;
        --dashboard-danger: #e74c3c;
        --dashboard-info: #3498db;
    }
    
    /* Make sidebar section headers non-clickable */
    #content-related h2,
    #content-related caption {
        pointer-events: none;
        cursor: default;
    }
    
    #content-related h2 a,
    #content-related caption a {
        pointer-events: none;
        cursor: default;
        text-decoration: none;
        color: inherit;
    }
    
    /* Dashboard Container */
    .analytics-dashboard {
        margin: 0;
        padding: 0;
    }
    
    .dashboard-header {
        margin: 0 0 32px 0;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--hairline-color);
    }
    
    .dashboard-title {
        font-size: 24px;
        font-weight: 400;
        color: var(--body-fg);
        margin: 0;
        letter-spacing: -0.5px;
    }
    
    /* Tabs Navigation */
    .dashboard-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 32px;
        border-bottom: 1px solid var(--hairline-color);
    }
    
    .tab-btn {
        background: none;
        border: none;
        padding: 12px 24px;
        font-size: 13px;
        font-weight: 500;
        color: var(--body-quiet-color);
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        position: relative;
        margin-bottom: -1px;
    }
    
    .tab-btn:hover {
        color: var(--link-fg);
    }
    
    .tab-btn.active {
        color: var(--link-selected-fg);
        border-bottom-color: var(--link-selected-fg);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }
    
    .stat-card {
        background: var(--body-bg);
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
        padding: 20px;
        transition: box-shadow 0.2s;
    }
    
    .stat-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-label {
        font-size: 11px;
        color: var(--body-quiet-color);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: 300;
        color: var(--body-fg);
        margin-bottom: 4px;
        letter-spacing: -0.5px;
    }
    
    .stat-subtext {
        font-size: 12px;
        color: var(--body-quiet-color);
    }
    
    /* Charts */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    
    .chart-card {
        background: var(--body-bg);
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
        padding: 24px;
    }
    
    .chart-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--body-fg);
        margin: 0 0 20px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        position: relative;
        height: 260px;
    }
    
    /* Tables */
    .data-table-section {
        background: var(--body-bg);
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .table-header {
        padding: 16px 20px;
        background: var(--darkened-bg);
        border-bottom: 1px solid var(--hairline-color);
    }
    
    .table-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--body-fg);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead {
        background: var(--darkened-bg);
    }
    
    .data-table th {
        padding: 12px 20px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: var(--body-quiet-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .data-table td {
        padding: 12px 20px;
        border-top: 1px solid var(--hairline-color);
        color: var(--body-fg);
        font-size: 13px;
    }
    
    .data-table tbody tr:hover {
        background: var(--darkened-bg);
    }
    
    /* Status Badges */
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .badge-pending {
        background: rgba(243, 156, 18, 0.1);
        color: #e67e22;
    }
    
    .badge-confirmed {
        background: rgba(46, 204, 113, 0.1);
        color: #27ae60;
    }
    
    .badge-completed {
        background: rgba(52, 152, 219, 0.1);
        color: #2980b9;
    }
    
    .badge-cancelled {
        background: rgba(231, 76, 60, 0.1);
        color: #c0392b;
    }
    
    /* Performers List */
    .performers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .performer-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .performer-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--hairline-color);
    }
    
    .performer-item:last-child {
        border-bottom: none;
    }
    
    .performer-name {
        font-size: 13px;
        color: var(--body-fg);
        font-weight: 500;
    }
    
    .performer-value {
        font-size: 14px;
        font-weight: 600;
        color: var(--link-fg);
    }
    
    .section-divider {
        margin: 48px 0;
        border: none;
        border-top: 1px solid var(--hairline-color);
    }
    
    .admin-section-title {
        font-size: 18px;
        font-weight: 400;
        color: var(--body-fg);
        margin: 32px 0 24px 0;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--hairline-color);
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
<div class="analytics-dashboard">
    <div class="dashboard-header">
        <h1 class="dashboard-title">RIVIÃˆRE RV PARK - Analytics Dashboard</h1>
    </div>
    
    <!-- Tabs -->
    <div class="dashboard-tabs">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="bookings">Bookings</button>
        <button class="tab-btn" data-tab="revenue">Revenue</button>
        <button class="tab-btn" data-tab="sites">Sites</button>
    </div>
    
    <!-- Overview Tab -->
    <div class="tab-content active" id="overview-tab">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value">${{ total_revenue|floatformat:0 }}</div>
                <div class="stat-subtext">All confirmed bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Bookings</div>
                <div class="stat-value">{{ total_bookings }}</div>
                <div class="stat-subtext">All time</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">RV Sites</div>
                <div class="stat-value">{{ total_lands }}</div>
                <div class="stat-subtext">Total available</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending</div>
                <div class="stat-value">{{ pending_bookings }}</div>
                <div class="stat-subtext">Awaiting confirmation</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Occupancy Rate</div>
                <div class="stat-value">{{ occupancy_rate }}%</div>
                <div class="stat-subtext">Last 30 days</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Booking</div>
                <div class="stat-value">${{ avg_booking_value|floatformat:0 }}</div>
                <div class="stat-subtext">Per booking</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Booking Trend</h3>
                <div class="chart-container">
                    <canvas id="bookingChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Revenue Trend</h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Booking Status</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Site Status</h3>
                <div class="chart-container">
                    <canvas id="siteChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bookings Tab -->
    <div class="tab-content" id="bookings-tab">
        <div class="charts-grid" style="grid-template-columns: 1fr;">
            <div class="chart-card">
                <h3 class="chart-title">Booking Timeline (30 Days)</h3>
                <div class="chart-container" style="height: 320px;">
                    <canvas id="bookingChart2"></canvas>
                </div>
            </div>
        </div>
        
        <div class="data-table-section">
            <div class="table-header">
                <h3 class="table-title">Recent Bookings</h3>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Guest</th>
                        <th>Site</th>
                        <th>Check-in</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in recent_bookings %}
                    <tr>
                        <td>#{{ booking.id }}</td>
                        <td>{{ booking.guest_name }}</td>
                        <td>{{ booking.land.name }}</td>
                        <td>{{ booking.check_in|date:"M d, Y" }}</td>
                        <td>${{ booking.total_price|floatformat:0 }}</td>
                        <td><span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" style="text-align: center; color: var(--body-quiet-color);">No recent bookings</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="data-table-section">
            <div class="table-header">
                <h3 class="table-title">Upcoming Bookings (30 Days)</h3>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Guest</th>
                        <th>Site</th>
                        <th>Check-in</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in upcoming_bookings %}
                    <tr>
                        <td>#{{ booking.id }}</td>
                        <td>{{ booking.guest_name }}</td>
                        <td>{{ booking.land.name }}</td>
                        <td>{{ booking.check_in|date:"M d, Y" }}</td>
                        <td>{{ booking.total_nights }} nights</td>
                        <td><span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" style="text-align: center; color: var(--body-quiet-color);">No upcoming bookings</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Revenue Tab -->
    <div class="tab-content" id="revenue-tab">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value">${{ total_revenue|floatformat:0 }}</div>
                <div class="stat-subtext">All time</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">30-Day Revenue</div>
                <div class="stat-value">${{ revenue_30|floatformat:0 }}</div>
                <div class="stat-subtext">{{ bookings_30_count }} bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">90-Day Revenue</div>
                <div class="stat-value">${{ revenue_90|floatformat:0 }}</div>
                <div class="stat-subtext">{{ bookings_90_count }} bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Booking Value</div>
                <div class="stat-value">${{ avg_booking_value|floatformat:0 }}</div>
                <div class="stat-subtext">Average per booking</div>
            </div>
        </div>
        
        <div class="charts-grid" style="grid-template-columns: 1fr;">
            <div class="chart-card">
                <h3 class="chart-title">Revenue Timeline (30 Days)</h3>
                <div class="chart-container" style="height: 320px;">
                    <canvas id="revenueChart2"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sites Tab -->
    <div class="tab-content" id="sites-tab">
        <div class="data-table-section">
            <div class="table-header">
                <h3 class="table-title">Top Performing Sites</h3>
            </div>
            <div style="padding: 24px;">
                <div class="performers-grid">
                    <div>
                        <h4 style="font-size: 13px; color: var(--body-quiet-color); text-transform: uppercase; margin: 0 0 16px 0; font-weight: 600; letter-spacing: 0.5px;">By Bookings</h4>
                        <ul class="performer-list">
                            {% for land in top_lands %}
                            <li class="performer-item">
                                <span class="performer-name">{{ land.name }}</span>
                                <span class="performer-value">{{ land.booking_count }}</span>
                            </li>
                            {% empty %}
                            <li style="color: var(--body-quiet-color); padding: 12px 0;">No data available</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; color: var(--body-quiet-color); text-transform: uppercase; margin: 0 0 16px 0; font-weight: 600; letter-spacing: 0.5px;">By Revenue</h4>
                        <ul class="performer-list">
                            {% for land in top_lands_revenue %}
                            <li class="performer-item">
                                <span class="performer-name">{{ land.name }}</span>
                                <span class="performer-value">${{ land.total_revenue|floatformat:0 }}</span>
                            </li>
                            {% empty %}
                            <li style="color: var(--body-quiet-color); padding: 12px 0;">No data available</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Site Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="siteChart2"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <hr class="section-divider">
 
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
    // Chart.js Configuration
    const chartColors = {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--link-fg') || '#417690',
        success: '#27ae60',
        warning: '#f39c12',
        danger: '#e74c3c',
        info: '#3498db'
    };
    
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                labels: {
                    font: { size: 11, family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
                    padding: 16
                }
            }
        }
    };
    
    // Booking Chart
    new Chart(document.getElementById('bookingChart'), {
        type: 'line',
        data: {
            labels: {{ booking_timeline|safe }}.map(d => d.date),
            datasets: [{
                label: 'Bookings',
                data: {{ booking_timeline|safe }}.map(d => d.count),
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primary + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
    });
    
    // Booking Chart 2
    new Chart(document.getElementById('bookingChart2'), {
        type: 'line',
        data: {
            labels: {{ booking_timeline|safe }}.map(d => d.date),
            datasets: [{
                label: 'Bookings Created',
                data: {{ booking_timeline|safe }}.map(d => d.count),
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primary + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
    });
    
    // Revenue Chart
    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: {
            labels: {{ revenue_timeline|safe }}.map(d => d.date),
            datasets: [{
                label: 'Revenue',
                data: {{ revenue_timeline|safe }}.map(d => d.revenue),
                backgroundColor: chartColors.success + '80',
                borderColor: chartColors.success,
                borderWidth: 1
            }]
        },
        options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
    });
    
    // Revenue Chart 2
    new Chart(document.getElementById('revenueChart2'), {
        type: 'bar',
        data: {
            labels: {{ revenue_timeline|safe }}.map(d => d.date),
            datasets: [{
                label: 'Revenue ($)',
                data: {{ revenue_timeline|safe }}.map(d => d.revenue),
                backgroundColor: chartColors.success + '80',
                borderColor: chartColors.success,
                borderWidth: 1
            }]
        },
        options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
    });
    
    // Status Chart
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: {{ status_distribution|safe }}.map(s => s.status.charAt(0).toUpperCase() + s.status.slice(1)),
            datasets: [{
                data: {{ status_distribution|safe }}.map(s => s.count),
                backgroundColor: [chartColors.warning + '80', chartColors.success + '80', chartColors.danger + '80', chartColors.info + '80'],
                borderWidth: 0
            }]
        },
        options: chartOptions
    });
    
    // Site Chart
    new Chart(document.getElementById('siteChart'), {
        type: 'pie',
        data: {
            labels: {{ land_status|safe }}.map(s => s.status.charAt(0).toUpperCase() + s.status.slice(1)),
            datasets: [{
                data: {{ land_status|safe }}.map(s => s.count),
                backgroundColor: [chartColors.success + '80', chartColors.danger + '80'],
                borderWidth: 0
            }]
        },
        options: chartOptions
    });
    
    // Site Chart 2
    new Chart(document.getElementById('siteChart2'), {
        type: 'pie',
        data: {
            labels: {{ land_status|safe }}.map(s => s.status.charAt(0).toUpperCase() + s.status.slice(1)),
            datasets: [{
                data: {{ land_status|safe }}.map(s => s.count),
                backgroundColor: [chartColors.success + '80', chartColors.danger + '80'],
                borderWidth: 0
            }]
        },
        options: chartOptions
    });
    
    // Tab Switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab + '-tab').classList.add('active');
        });
    });
</script>
{% endblock %}
